import{w as O,b as W,r as n,j as t}from"./chunk-EPOLDU6W-CtJUS6UA.js";import{P as T,C as _,T as r,I as $,B as A,a as q,b as H,c as z}from"./Page-CddeMGQL.js";import{L as m}from"./Layout-oDW7u1wt.js";import{E as G,R as J,a as K,S as Q}from"./ResourceList-CEsphelE.js";import{B as b}from"./Banner-BpNjYVCp.js";import{M as w}from"./Modal-Cur2sQoD.js";import{F as V}from"./FormLayout-C02gfIJ1.js";import"./context-L_wT5nQs.js";import"./index-CfIiKg0r.js";import"./Sticky-DM3L7XRA.js";import"./context-BHNIoJ7-.js";const ie=O(function(){var I;const M=W(),[x,N]=n.useState([]),[y,v]=n.useState(!0),[j,a]=n.useState(""),[D,c]=n.useState(""),[i,d]=n.useState(null),[U,u]=n.useState(!1),[S,h]=n.useState(null),[p,k]=n.useState(""),[f,E]=n.useState(0),[P,l]=n.useState("");n.useEffect(()=>{g()},[]),n.useEffect(()=>{const e=setInterval(async()=>{try{console.log("Checking for scheduled updates...");const s=await(await fetch("/api/update-scheduled",{method:"POST"})).json();console.log("Scheduled update result:",s),s.details&&s.details.length>0&&(console.log("Updated",s.updated,"schedules"),await g(),c(`Scheduled updates applied for ${s.updated} collection(s).`))}catch(o){console.error("Error checking scheduled updates:",o)}},6e4);return()=>clearInterval(e)},[]);const g=async()=>{try{v(!0),a(""),console.log("Fetching collections...");const e=await fetch("/api/manage-collections");if(console.log("Fetch status:",e.status),e.ok){const o=await e.json();console.log("Fetched collections data:",o),N(o||[]),console.log("Collections count:",(o==null?void 0:o.length)||0)}else{const o=await e.json().catch(()=>({}));a(`Failed to load collections: ${o.error||e.statusText}`),console.error("API error:",o)}}catch(e){const o="Network error loading collections";a(o),console.error(o,e)}finally{v(!1)}},F=async e=>{try{const o=new FormData;o.append("_action","delete"),o.append("id",e);const s=await fetch("/api/manage-collections",{method:"POST",body:o}),C=await s.json();s.ok?(C.success?c("Collection deleted successfully"):c(`Cleanup completed with warnings: ${C.message}`),g()):a(C.error||"Delete failed")}catch(o){a("Network error deleting collection"),console.error("Delete error:",o)}d(null),u(!1)},L=e=>{d(e),u(!0)},B=async()=>{if(!S||!p||f<0){l("Please fill in all fields");return}try{const e=new FormData;e.append("_action","update"),e.append("id",S),e.append("schedule",p),e.append("numProducts",f.toString());const o=await fetch("/api/manage-collections",{method:"POST",body:e}),s=await o.json();o.ok&&s.success?(c("Schedule updated successfully"),g(),h(null),l("")):(l(s.error||"Update failed"),console.error("Update error:",s))}catch(e){l("Network error updating schedule"),console.error("Update error:",e)}},R={singular:"collection",plural:"collections"};return!y&&x.length===0&&!j?t.jsx(T,{title:"Manage Collections",children:t.jsx(m,{children:t.jsx(m.Section,{children:t.jsx(G,{heading:"No collections yet",action:{content:"Create a discount collection",onAction:()=>M("/app")},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate.svg",children:t.jsx("p",{children:"Create your first scheduled discount collection to manage it here."})})})})}):t.jsxs(T,{title:"Manage Collections",children:[t.jsx(m,{children:t.jsxs(m.Section,{children:[j&&t.jsx(b,{tone:"critical",onDismiss:()=>a(""),children:j}),D&&t.jsx(b,{tone:"success",onDismiss:()=>c(""),children:D}),t.jsx(_,{children:t.jsx(J,{resourceName:R,items:x,selectable:!1,renderItem:e=>(console.log("Rendering item:",e),t.jsxs(K,{id:e.id,children:[t.jsxs(r,{variant:"bodyMd",fontWeight:"bold",as:"h3",children:[e.collectionTitle||"Untitled Collection"," "]}),t.jsxs(r,{variant:"bodySm",tone:"subdued",as:"p",children:["Tag: ",e.uniqueTag," | Products: ",e.numProducts," | Next Update: ",new Date(e.nextUpdate).toLocaleString()]}),t.jsxs(r,{variant:"bodyMd",tone:"subdued",as:"p",children:[e.schedule," schedule"]}),t.jsxs($,{gap:"200",align:"end",children:[t.jsx(A,{onClick:()=>{console.log("Edit clicked for:",e.id),h(e.id),k(e.schedule),E(e.numProducts),l("")},children:"Edit"}),t.jsx(A,{destructive:!0,onClick:()=>{console.log("Delete clicked for:",e.id),L(e.id)},children:"Delete"})]})]}))})})]})}),t.jsx(w,{open:U,title:"Delete Collection",onClose:()=>{u(!1),d(null)},primaryAction:{content:"Delete",destructive:!0,onAction:()=>i&&F(i),loading:y},secondaryActions:[{content:"Cancel",onAction:()=>{u(!1),d(null)}}],children:t.jsx(w.Section,{children:t.jsxs(q,{gap:"400",children:[t.jsx(r,{variant:"bodyMd",as:"p",children:"This will remove the tag from all products, delete the Shopify collection, and remove the schedule. This action cannot be undone. Are you sure?"}),i&&t.jsxs(r,{variant:"bodyMd",fontWeight:"semibold",as:"p",children:["Collection: ",((I=x.find(e=>e.id===i))==null?void 0:I.collectionTitle)||"Untitled"]})]})})}),t.jsx(w,{open:!!S,title:"Edit Schedule",onClose:()=>{h(null),l("")},primaryAction:{content:"Update",onAction:B,disabled:!p||f<0,loading:y},secondaryActions:[{content:"Cancel",onAction:()=>{h(null),l("")}}],children:t.jsxs(V,{children:[t.jsx(Q,{label:"Update Frequency",options:[{label:"Minutely",value:"minutely"},{label:"Hourly",value:"hourly"},{label:"Daily",value:"daily"},{label:"Weekly",value:"weekly"}],value:p,onChange:k}),t.jsx(H,{label:"Number of Products",type:"number",value:f.toString(),onChange:e=>E(parseInt(e)||0),min:0,helpText:"Number of random products to tag on refresh (0 = all).",autoComplete:"off"}),P&&t.jsx(z,{message:P,fieldID:"edit-error"}),t.jsx(b,{tone:"info",title:"Note",children:"Changes take effect on the next scheduled refresh."})]})})]})});export{ie as default};
